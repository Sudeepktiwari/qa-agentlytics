<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Robust Parsing Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background: #f8f9fa;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .test-case {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
      }
      .test-input {
        background: #e9ecef;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
        margin-bottom: 10px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .test-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      .result {
        margin-top: 15px;
        padding: 15px;
        background: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
      }
      .success {
        border-left: 4px solid #28a745;
      }
      .error {
        border-left: 4px solid #dc3545;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ Robust AI Response Parsing Test</h1>
      <p>
        This page tests the new robust parsing logic that handles multiple JSON
        objects and various AI response formats.
      </p>

      <div class="test-case">
        <h3>
          Test Case 1: Multiple Separate JSON Objects (Your Original Issue)
        </h3>
        <div class="test-input" id="test1-input">
          { "mainText": "Looking for efficient scheduling solutions? Let's
          explore how Calendly can simplify your booking process!<br /><br />‚Ä¢
          Seamless integration with your video conferencing tools<br /><br />‚Ä¢
          Customizable event types for every meeting scenario<br /><br />‚Ä¢
          Automated reminders to reduce no-shows and improve attendance<br /><br />Feel
          free to ask any specific questions or let me know your needs!" } {
          "buttons": ["Learn more about integrations", "Explore customizable
          event types", "Discover scheduling automation"] } { "emailPrompt": "I
          can send you detailed information on Calendly's scheduling solutions!
          Please provide your email to receive more insights." }
        </div>
        <button class="test-button" onclick="testCase1()">Test Parse</button>
        <div id="test1-result" class="result" style="display: none"></div>
      </div>

      <div class="test-case">
        <h3>Test Case 2: Single Valid JSON Object</h3>
        <div class="test-input" id="test2-input">
          { "mainText": "Great! I'd love to help you schedule a demo. Please
          select a convenient time:", "buttons": ["Book Demo", "Learn More"],
          "emailPrompt": "Enter your email for confirmation",
          "showBookingCalendar": true, "bookingType": "demo" }
        </div>
        <button class="test-button" onclick="testCase2()">Test Parse</button>
        <div id="test2-result" class="result" style="display: none"></div>
      </div>

      <div class="test-case">
        <h3>Test Case 3: Plain Text with No JSON</h3>
        <div class="test-input" id="test3-input">
          I'd be happy to help you with your scheduling needs. What specific
          features are you interested in?
        </div>
        <button class="test-button" onclick="testCase3()">Test Parse</button>
        <div id="test3-result" class="result" style="display: none"></div>
      </div>

      <div class="test-case">
        <h3>Test Case 4: Malformed JSON with Readable Text</h3>
        <div class="test-input" id="test4-input">
          Here's some helpful information about our product: { "mainText": "Our
          scheduling solution offers great features" { "buttons": ["Get
          Started", "Learn More" Plus, we have excellent customer support
          available 24/7!
        </div>
        <button class="test-button" onclick="testCase4()">Test Parse</button>
        <div id="test4-result" class="result" style="display: none"></div>
      </div>

      <div class="test-case">
        <h3>Test Case 5: JSON with Markdown Formatting</h3>
        <div class="test-input" id="test5-input">
          { "mainText": "**Welcome** to our platform!\n\nHere are the key
          benefits:\n‚Ä¢ Easy integration\n‚Ä¢ **Automated** scheduling\n‚Ä¢ *Smart*
          notifications", "buttons": ["Start Free Trial", "View Pricing"],
          "emailPrompt": "" }
        </div>
        <button class="test-button" onclick="testCase5()">Test Parse</button>
        <div id="test5-result" class="result" style="display: none"></div>
      </div>

      <button
        class="test-button"
        onclick="testAllCases()"
        style="background: #28a745; margin-top: 20px"
      >
        Run All Tests
      </button>
    </div>

    <script>
      // Mock implementation of the robust parsing function for testing
      function parseAIResponse(content) {
        if (!content || content.trim() === "") {
          return {
            mainText: "I'd be happy to help you with that!",
            buttons: [],
            emailPrompt: "",
            followupQuestion: "",
            showBookingCalendar: false,
            bookingType: undefined,
          };
        }

        try {
          // Method 1: Try parsing as single JSON object first
          const singleJsonMatch = content.match(/^\s*\{[\s\S]*\}\s*$/);
          if (singleJsonMatch) {
            const parsed = JSON.parse(content);
            return {
              mainText: parsed.mainText || parsed.answer || content,
              buttons: parsed.buttons || [],
              emailPrompt: parsed.emailPrompt || "",
              followupQuestion: parsed.followupQuestion || "",
              showBookingCalendar: parsed.showBookingCalendar || false,
              bookingType: parsed.bookingType || undefined,
            };
          }

          // Method 2: Extract multiple JSON objects from the response
          const result = {};

          // Extract mainText from first JSON object (handle escaped quotes and newlines)
          const mainTextMatch = content.match(
            /\{\s*"mainText":\s*"([^"]*(?:\\.[^"]*)*)"/
          );
          if (mainTextMatch) {
            result.mainText = mainTextMatch[1]
              .replace(/\\n/g, "\n")
              .replace(/\\"/g, '"')
              .replace(/\\\\/g, "\\")
              .replace(/‚Ä¢/g, "‚Ä¢");
          }

          // Extract buttons array
          const buttonsMatch = content.match(
            /\{\s*"buttons":\s*(\[[^\]]*\])\s*\}/
          );
          if (buttonsMatch) {
            try {
              result.buttons = JSON.parse(buttonsMatch[1]);
            } catch (e) {
              const buttonStrings = buttonsMatch[1].match(/"([^"]+)"/g);
              if (buttonStrings) {
                result.buttons = buttonStrings.map((str) => str.slice(1, -1));
              }
            }
          }

          // Extract emailPrompt
          const emailMatch = content.match(
            /\{\s*"emailPrompt":\s*"([^"]*(?:\\.[^"]*)*)"/
          );
          if (emailMatch) {
            result.emailPrompt = emailMatch[1]
              .replace(/\\n/g, "\n")
              .replace(/\\"/g, '"')
              .replace(/\\\\/g, "\\");
          }

          // If we found mainText, process markdown and return
          if (result.mainText) {
            result.mainText = result.mainText
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
              .replace(/\*(.*?)\*/g, "<em>$1</em>")
              .replace(/\n\n/g, "<br><br>")
              .replace(/\n/g, "<br>")
              .trim();

            return {
              mainText: result.mainText,
              buttons: result.buttons || [],
              emailPrompt: result.emailPrompt || "",
              followupQuestion: result.followupQuestion || "",
              showBookingCalendar: result.showBookingCalendar || false,
              bookingType: result.bookingType || undefined,
            };
          }

          // Method 3: Extract readable text as fallback
          let extractedText = content;
          extractedText = extractedText
            .replace(/\{[^}]*\}/g, "")
            .replace(/^\s*[\{\}]\s*/gm, "")
            .replace(/^\s*"[^"]*":\s*/gm, "")
            .replace(/,\s*$/gm, "")
            .replace(/\s+/g, " ")
            .trim();

          if (extractedText && extractedText.length > 5) {
            extractedText = extractedText
              .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
              .replace(/\*(.*?)\*/g, "<em>$1</em>")
              .replace(/\n\n/g, "<br><br>")
              .replace(/\n/g, "<br>")
              .trim();

            return {
              mainText: extractedText,
              buttons: [],
              emailPrompt: "",
              followupQuestion: "",
              showBookingCalendar: false,
              bookingType: undefined,
            };
          }

          return {
            mainText: "I'd be happy to help you with that!",
            buttons: [],
            emailPrompt: "",
            followupQuestion: "",
            showBookingCalendar: false,
            bookingType: undefined,
          };
        } catch (error) {
          const cleanText = content
            .replace(/\{[^}]*\}/g, " ")
            .replace(/[{}"\[\]]/g, " ")
            .replace(/\s+/g, " ")
            .trim();

          return {
            mainText: cleanText || "I'd be happy to help you with that!",
            buttons: [],
            emailPrompt: "",
            followupQuestion: "",
            showBookingCalendar: false,
            bookingType: undefined,
          };
        }
      }

      function runTest(testNumber, input) {
        const resultDiv = document.getElementById(`test${testNumber}-result`);
        resultDiv.style.display = "block";

        try {
          const parsed = parseAIResponse(input);
          resultDiv.className = "result success";
          resultDiv.innerHTML = `
                    <strong>‚úÖ Parsing Successful!</strong><br>
                    <strong>Main Text:</strong> ${parsed.mainText}<br>
                    <strong>Buttons:</strong> ${JSON.stringify(
                      parsed.buttons
                    )}<br>
                    <strong>Email Prompt:</strong> ${
                      parsed.emailPrompt || "None"
                    }<br>
                    <strong>Show Calendar:</strong> ${
                      parsed.showBookingCalendar
                    }<br>
                    <strong>Booking Type:</strong> ${
                      parsed.bookingType || "None"
                    }
                `;
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>‚ùå Parsing Failed:</strong> ${error.message}`;
        }
      }

      function testCase1() {
        const input = document.getElementById("test1-input").textContent;
        runTest(1, input);
      }

      function testCase2() {
        const input = document.getElementById("test2-input").textContent;
        runTest(2, input);
      }

      function testCase3() {
        const input = document.getElementById("test3-input").textContent;
        runTest(3, input);
      }

      function testCase4() {
        const input = document.getElementById("test4-input").textContent;
        runTest(4, input);
      }

      function testCase5() {
        const input = document.getElementById("test5-input").textContent;
        runTest(5, input);
      }

      function testAllCases() {
        testCase1();
        setTimeout(() => testCase2(), 100);
        setTimeout(() => testCase3(), 200);
        setTimeout(() => testCase4(), 300);
        setTimeout(() => testCase5(), 400);
      }
    </script>
  </body>
</html>
