<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ü§ñ Bot Mode Indicator Test - Live Widget</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
        line-height: 1.6;
      }
      .test-container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status-panel {
        background: #e8f5e8;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 5px solid #4caf50;
      }
      .instructions {
        background: #fff3e0;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 5px solid #ff9800;
      }
      .debug-console {
        background: #263238;
        color: #4caf50;
        padding: 15px;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        font-size: 14px;
        margin-top: 20px;
        min-height: 100px;
        overflow-y: auto;
      }
      .highlight {
        background: #ffeb3b;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
      }
      .mode-examples {
        display: flex;
        gap: 20px;
        margin: 20px 0;
      }
      .mode-example {
        flex: 1;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .lead-mode {
        background: #f3e5f5;
        border: 2px solid #e1bee7;
        color: #7b1fa2;
      }
      .sales-mode {
        background: #e3f2fd;
        border: 2px solid #bbdefb;
        color: #1976d2;
      }
      .widget-area {
        margin-top: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>ü§ñ Bot Mode Indicator Test - Live Widget</h1>

      <div class="status-panel">
        <h3>‚úÖ Test Environment Ready</h3>
        <p><strong>Server Status:</strong> Next.js running on localhost:3000</p>
        <p>
          <strong>Widget Loading:</strong>
          <span id="widget-status">Checking...</span>
        </p>
        <p>
          <strong>Indicator Status:</strong>
          <span id="indicator-status">Waiting for widget...</span>
        </p>
      </div>

      <div class="instructions">
        <h3>üìã Testing Instructions</h3>
        <ol>
          <li>
            <strong>Look for the chatbot widget below</strong> - it should
            appear in the widget area
          </li>
          <li>
            <strong>Check the top-right corner</strong> of the chatbot for the
            mode indicator
          </li>
          <li>
            <strong>Initial state:</strong> Should show
            <span class="highlight">purple "LEAD MODE"</span>
          </li>
          <li>
            <strong>Type a message</strong> like "Hello" or "What services do
            you offer?"
          </li>
          <li>
            <strong>Provide email when asked</strong> - type something like "My
            email is test@example.com"
          </li>
          <li>
            <strong>Watch for mode switch</strong> to
            <span class="highlight">blue "SALES MODE"</span>
          </li>
        </ol>
      </div>

      <div class="mode-examples">
        <div class="mode-example lead-mode">
          <h4>üü£ LEAD MODE</h4>
          <p>Purple badge</p>
          <p>Before email provided</p>
        </div>
        <div class="mode-example sales-mode">
          <h4>üîµ SALES MODE</h4>
          <p>Blue badge with email</p>
          <p>After email provided</p>
        </div>
      </div>

      <div class="widget-area">
        <h3>üì± Chatbot Widget</h3>
        <p>The chatbot widget should appear below:</p>
        <div id="widget-container">
          <!-- Widget will load here -->
        </div>
      </div>

      <div class="debug-console" id="debug-console">
        <div><strong>üîç Debug Console:</strong></div>
        <div>Initializing widget test...</div>
      </div>
    </div>

    <!-- Load the actual chatbot widget -->
    <script
      src="http://localhost:3000/api/widget"
      data-api-key="ak_e8a971aee600130a0dcc93ca0fbb8831e366c4566f6b80426991b4ed6c8f9848"
      data-theme="blue"
      data-chat-title="Bot Mode Test"
      data-welcome-message="Hello! I'm here to help. Notice the mode indicator in the top-right corner!"
      data-voice-enabled="false"
      data-auto-open-proactive="true"
      data-container-id="widget-container"
    ></script>

    <script>
      const debugConsole = document.getElementById("debug-console");
      const widgetStatus = document.getElementById("widget-status");
      const indicatorStatus = document.getElementById("indicator-status");

      function addDebugLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.createElement("div");
        logDiv.style.color =
          type === "error"
            ? "#f44336"
            : type === "success"
            ? "#4caf50"
            : "#81c784";
        logDiv.innerHTML = `[${timestamp}] ${message}`;
        debugConsole.appendChild(logDiv);
        debugConsole.scrollTop = debugConsole.scrollHeight;
      }

      function checkForWidget() {
        addDebugLog("üîç Checking for widget...");

        // Check if widget script loaded
        if (window.appointyChatbot) {
          addDebugLog("‚úÖ Widget API found!", "success");
          widgetStatus.textContent = "‚úÖ Loaded";
          widgetStatus.style.color = "#4caf50";

          checkForIndicator();
        } else {
          addDebugLog("‚ùå Widget API not found yet...", "error");
          widgetStatus.textContent = "‚ùå Not loaded";
          widgetStatus.style.color = "#f44336";
        }
      }

      function checkForIndicator() {
        addDebugLog("üéØ Looking for mode indicator...");

        // Look for the indicator element
        const indicators = document.querySelectorAll(
          '[style*="borderRadius: 12"]'
        );
        const chatbotContainers = document.querySelectorAll(
          '[style*="border: 1px solid #ccc"]'
        );

        addDebugLog(`Found ${chatbotContainers.length} chatbot containers`);
        addDebugLog(`Found ${indicators.length} potential indicators`);

        if (indicators.length > 0) {
          const indicator = indicators[0];
          const text = indicator.textContent;
          addDebugLog(`‚úÖ Mode indicator found: "${text}"`, "success");
          indicatorStatus.textContent = `‚úÖ Found: ${text}`;
          indicatorStatus.style.color = "#4caf50";

          // Monitor for mode changes
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (
                mutation.type === "childList" ||
                mutation.type === "characterData"
              ) {
                const newText = indicator.textContent;
                addDebugLog(`üîÑ Mode changed: "${newText}"`, "success");
                indicatorStatus.textContent = `‚úÖ Current: ${newText}`;
              }
            });
          });

          observer.observe(indicator, {
            childList: true,
            subtree: true,
            characterData: true,
          });
        } else {
          addDebugLog("‚ùå Mode indicator not found yet", "error");
          indicatorStatus.textContent = "‚ùå Not found";
          indicatorStatus.style.color = "#f44336";
        }
      }

      // Monitor API requests
      const originalFetch = window.fetch;
      window.fetch = function (...args) {
        const [url, options] = args;
        if (url.includes("/api/chat")) {
          addDebugLog(`üì° API Request: ${url}`);

          return originalFetch.apply(this, args).then((response) => {
            return response
              .clone()
              .json()
              .then((data) => {
                if (data.botMode) {
                  addDebugLog(`ü§ñ Bot Mode: ${data.botMode}`, "success");
                  if (data.userEmail) {
                    addDebugLog(`üìß User Email: ${data.userEmail}`, "success");
                  }
                }
                return response;
              })
              .catch(() => response);
          });
        }
        return originalFetch.apply(this, args);
      };

      // Start checking
      addDebugLog("üöÄ Starting widget test...");

      // Check every 2 seconds
      const checkInterval = setInterval(() => {
        checkForWidget();
      }, 2000);

      // Initial check after 1 second
      setTimeout(checkForWidget, 1000);

      // Stop checking after 30 seconds
      setTimeout(() => {
        clearInterval(checkInterval);
        addDebugLog("‚è±Ô∏è Stopping automatic checks after 30 seconds");
      }, 30000);
    </script>
  </body>
</html>
