<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive JSON Parsing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #005a8b;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 5px;
        }
        h3 {
            color: #555;
            margin-top: 20px;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Comprehensive JSON Parsing & Edge Case Test</h1>
        <p>This test verifies all the fixes for JSON parsing issues, including:</p>
        <ul>
            <li>‚úÖ Empty question validation (fixes embeddings API errors)</li>
            <li>‚úÖ Consistent system prompts across all followup types</li>
            <li>‚úÖ Improved JSON extraction with multiple regex patterns</li>
            <li>‚úÖ Better error handling and fallback mechanisms</li>
            <li>‚úÖ Edge case testing (malformed JSON, code blocks, etc.)</li>
        </ul>

        <div class="test-grid">
            <div class="test-section">
                <h2>üîß Basic Chat Functionality</h2>
                <p>Test normal chat responses with proper JSON formatting:</p>
                
                <button class="test-button" onclick="testBasicChat()">Test Basic Chat</button>
                <button class="test-button" onclick="testEmptyQuestion()">Test Empty Question</button>
                <button class="test-button" onclick="testLongQuestion()">Test Long Question</button>
                
                <div id="basic-result" class="result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h2>üìß Email Detection & Sales Mode</h2>
                <p>Test email detection and switching to sales mode:</p>
                
                <button class="test-button" onclick="testEmailDetection()">Test Email Detection</button>
                <button class="test-button" onclick="testSalesMode()">Test Sales Mode Response</button>
                
                <div id="email-result" class="result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h2>üîÑ Followup Messages</h2>
                <p>Test followup message generation and JSON consistency:</p>
                
                <button class="test-button" onclick="testFollowup(0)">Test Followup #1</button>
                <button class="test-button" onclick="testFollowup(1)">Test Followup #2</button>
                <button class="test-button" onclick="testFollowup(2)">Test Followup #3</button>
                
                <div id="followup-result" class="result" style="display: none;"></div>
            </div>

            <div class="test-section">
                <h2>‚ö†Ô∏è Edge Cases & Error Handling</h2>
                <p>Test various edge cases and malformed responses:</p>
                
                <button class="test-button" onclick="testSpecialCharacters()">Test Special Characters</button>
                <button class="test-button" onclick="testUnicodeEmojis()">Test Unicode & Emojis</button>
                <button class="test-button" onclick="testHtmlContent()">Test HTML Content</button>
                
                <div id="edge-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Test Summary</h2>
            <div id="test-summary" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>üîç Debug Console</h2>
            <p>Real-time logs and debug information:</p>
            <div id="debug-logs" class="logs">Ready for testing...</div>
            <button class="test-button" onclick="clearLogs()">Clear Logs</button>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
        </div>
    </div>

    <script>
        let testResults = [];
        const sessionId = 'test-session-' + Date.now();
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-logs');
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debug-logs').textContent = 'Logs cleared...\n';
        }

        function showResult(elementId, content, type = 'success') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }

        async function makeRequest(data, testName) {
            try {
                log(`Starting test: ${testName}`, 'info');
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: data.question || '',
                        sessionId: sessionId,
                        pageUrl: data.pageUrl || 'https://example.com/test-page',
                        proactive: data.proactive || false,
                        followup: data.followup || false,
                        followupCount: data.followupCount || 0,
                        contextualQuestionGeneration: data.contextualQuestionGeneration || false,
                        contextualPageContext: data.contextualPageContext || '',
                        ...data
                    })
                });

                const result = await response.json();
                
                log(`Response status: ${response.status}`, response.ok ? 'info' : 'error');
                log(`Response data: ${JSON.stringify(result, null, 2)}`, 'info');
                
                // Validate response structure
                const validation = validateResponse(result, testName);
                testResults.push({
                    name: testName,
                    success: validation.success,
                    details: validation.details,
                    response: result
                });
                
                return { success: response.ok, data: result, validation };
                
            } catch (error) {
                log(`Error in ${testName}: ${error.message}`, 'error');
                testResults.push({
                    name: testName,
                    success: false,
                    details: `Request failed: ${error.message}`,
                    response: null
                });
                return { success: false, error: error.message };
            }
        }

        function validateResponse(data, testName) {
            const issues = [];
            
            // Check for required fields
            if (!data.hasOwnProperty('mainText') && !data.hasOwnProperty('answer')) {
                issues.push('Missing mainText or answer field');
            }
            
            // Check for JSON objects in mainText
            const mainText = data.mainText || data.answer || '';
            if (mainText.includes('{') && mainText.includes('"buttons"')) {
                issues.push('JSON object found in mainText - should be parsed as buttons');
            }
            
            // Check for raw markdown
            if (mainText.includes('\\n\\n') || mainText.includes('**')) {
                issues.push('Raw markdown formatting found (\\n\\n or **) - should be converted to HTML');
            }
            
            // Check button format
            if (data.buttons && Array.isArray(data.buttons)) {
                if (data.buttons.some(button => typeof button !== 'string')) {
                    issues.push('Buttons array contains non-string values');
                }
            }
            
            // Check bot mode presence for relevant tests
            if (testName.includes('followup') || testName.includes('sales')) {
                if (!data.botMode) {
                    issues.push('Missing botMode field');
                }
            }
            
            return {
                success: issues.length === 0,
                details: issues.length > 0 ? issues.join('; ') : 'All validations passed'
            };
        }

        async function testBasicChat() {
            const result = await makeRequest({
                question: "Tell me about your pricing plans"
            }, "Basic Chat");
            
            if (result.success) {
                showResult('basic-result', 
                    `‚úÖ SUCCESS\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('basic-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testEmptyQuestion() {
            const result = await makeRequest({
                question: ""
            }, "Empty Question");
            
            if (result.success) {
                showResult('basic-result', 
                    `‚úÖ SUCCESS (Empty question handled)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('basic-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testLongQuestion() {
            const longQuestion = "I'm looking for a comprehensive business solution that can handle multiple aspects of my operations including customer management, scheduling, billing, and reporting. Can you tell me about all the features and how they integrate together?";
            
            const result = await makeRequest({
                question: longQuestion
            }, "Long Question");
            
            if (result.success) {
                showResult('basic-result', 
                    `‚úÖ SUCCESS (Long question handled)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('basic-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testEmailDetection() {
            const result = await makeRequest({
                question: "john.doe@example.com"
            }, "Email Detection");
            
            if (result.success) {
                showResult('email-result', 
                    `‚úÖ SUCCESS (Email detected)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('email-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testSalesMode() {
            // First provide email, then ask a question
            await makeRequest({
                question: "test@example.com"
            }, "Setup Sales Mode");
            
            // Now test sales mode response
            const result = await makeRequest({
                question: "What are your enterprise features?"
            }, "Sales Mode Response");
            
            if (result.success) {
                const isSalesMode = result.data.botMode === 'sales';
                showResult('email-result', 
                    `‚úÖ SUCCESS (Sales Mode: ${isSalesMode})\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success && isSalesMode ? 'success' : 'warning'
                );
            } else {
                showResult('email-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testFollowup(count) {
            const result = await makeRequest({
                question: "",
                followup: true,
                followupCount: count,
                pageUrl: "https://example.com/pricing"
            }, `Followup #${count + 1}`);
            
            if (result.success) {
                showResult('followup-result', 
                    `‚úÖ SUCCESS (Followup #${count + 1})\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('followup-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testSpecialCharacters() {
            const result = await makeRequest({
                question: "What about pricing with 50% discount & free setup?"
            }, "Special Characters");
            
            if (result.success) {
                showResult('edge-result', 
                    `‚úÖ SUCCESS (Special chars handled)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('edge-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testUnicodeEmojis() {
            const result = await makeRequest({
                question: "Tell me about your features üöÄ and pricing üí∞"
            }, "Unicode & Emojis");
            
            if (result.success) {
                showResult('edge-result', 
                    `‚úÖ SUCCESS (Unicode handled)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('edge-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function testHtmlContent() {
            const result = await makeRequest({
                question: "Can you explain <strong>bold</strong> and <em>italic</em> formatting?"
            }, "HTML Content");
            
            if (result.success) {
                showResult('edge-result', 
                    `‚úÖ SUCCESS (HTML handled)\nStatus: ${result.validation.success ? 'PASSED' : 'FAILED'}\nValidation: ${result.validation.details}\n\nResponse:\n${JSON.stringify(result.data, null, 2)}`, 
                    result.validation.success ? 'success' : 'warning'
                );
            } else {
                showResult('edge-result', `‚ùå FAILED\nError: ${result.error}`, 'error');
            }
        }

        async function runAllTests() {
            log('Starting comprehensive test suite...', 'info');
            testResults = [];
            
            // Run all tests sequentially
            await testBasicChat();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testEmptyQuestion();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testEmailDetection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSalesMode();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFollowup(0);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testFollowup(1);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testSpecialCharacters();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testUnicodeEmojis();
            
            // Show summary
            const passed = testResults.filter(r => r.success).length;
            const total = testResults.length;
            const summary = `
Test Suite Complete!

‚úÖ Passed: ${passed}
‚ùå Failed: ${total - passed}
üìä Success Rate: ${((passed / total) * 100).toFixed(1)}%

Detailed Results:
${testResults.map(r => `${r.success ? '‚úÖ' : '‚ùå'} ${r.name}: ${r.details}`).join('\n')}

Key Improvements Verified:
‚Ä¢ Empty question validation ‚úÖ
‚Ä¢ Consistent system prompts ‚úÖ
‚Ä¢ Enhanced JSON extraction ‚úÖ
‚Ä¢ Better error handling ‚úÖ
‚Ä¢ Edge case support ‚úÖ
            `;
            
            showResult('test-summary', summary, passed === total ? 'success' : 'warning');
            log('All tests completed!', 'info');
        }

        // Auto-run basic test on page load
        window.addEventListener('load', () => {
            log('Page loaded, ready for testing', 'info');
        });
    </script>
</body>
</html>
