<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Contextual Questions with Enhanced JSON Parsing</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .test-section {
        background: #f5f5f5;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
      }
      .pricing-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        text-align: center;
      }
      .cta-button {
        background: #ff6b6b;
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 18px;
        cursor: pointer;
        margin: 10px;
      }
      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .feature-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .testimonial {
        background: #e8f5e8;
        padding: 20px;
        border-left: 4px solid #4caf50;
        margin: 20px 0;
        font-style: italic;
      }
      .log {
        background: #f0f0f0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .test-controls {
        background: #fff3cd;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Enhanced Contextual Questions Testing</h1>
    <p>
      This page tests the enhanced contextual question generation with robust
      JSON parsing to prevent raw JSON from appearing in chat messages.
    </p>

    <div class="test-controls">
      <h3>Test Controls</h3>
      <button onclick="clearLogs()">Clear Logs</button>
      <button onclick="testWidget()">Test Widget Injection</button>
      <button onclick="simulateContextualQuestion()">
        Simulate Contextual Question
      </button>
      <div id="logs" class="log"></div>
    </div>

    <div class="pricing-section">
      <h2>Premium Business Solutions</h2>
      <p>Transform your business with our cutting-edge automation platform</p>
      <div class="pricing-plan">
        <h3>Enterprise Plan</h3>
        <div class="price">$299/month</div>
        <ul>
          <li>Unlimited automations</li>
          <li>Advanced integrations</li>
          <li>24/7 premium support</li>
          <li>Custom workflows</li>
        </ul>
      </div>
      <button class="cta-button" onclick="logAction('Pricing CTA clicked')">
        Start Free Trial
      </button>
      <button class="cta-button" onclick="logAction('Demo CTA clicked')">
        Book Demo
      </button>
    </div>

    <div class="features-grid">
      <div class="feature-card">
        <h3>ðŸ¤– AI-Powered Automation</h3>
        <p>
          Leverage advanced AI to automate complex business processes and
          decision-making workflows.
        </p>
      </div>
      <div class="feature-card">
        <h3>ðŸ“Š Real-time Analytics</h3>
        <p>
          Get instant insights with comprehensive dashboards and customizable
          reporting tools.
        </p>
      </div>
      <div class="feature-card">
        <h3>ðŸ”— Seamless Integrations</h3>
        <p>
          Connect with 500+ popular business tools and platforms with our robust
          API ecosystem.
        </p>
      </div>
      <div class="feature-card">
        <h3>ðŸ”’ Enterprise Security</h3>
        <p>
          Bank-level security with SOC 2 compliance, end-to-end encryption, and
          advanced access controls.
        </p>
      </div>
    </div>

    <div class="testimonial">
      <p>
        "This platform transformed our entire workflow. We've seen a 300%
        increase in efficiency and saved over $50,000 annually on operational
        costs."
      </p>
      <strong>- Sarah Johnson, CTO at TechCorp Solutions</strong>
    </div>

    <div class="test-section">
      <h3>Integration Benefits</h3>
      <p>Our platform seamlessly integrates with your existing tools:</p>
      <ul>
        <li>
          <strong>CRM Integration:</strong> Salesforce, HubSpot, Pipedrive
        </li>
        <li><strong>Communication:</strong> Slack, Microsoft Teams, Discord</li>
        <li><strong>Project Management:</strong> Asana, Trello, Monday.com</li>
        <li>
          <strong>Analytics:</strong> Google Analytics, Mixpanel, Amplitude
        </li>
      </ul>
      <button class="cta-button" onclick="logAction('Integration CTA clicked')">
        Explore Integrations
      </button>
    </div>

    <script>
      // Enhanced logging for debugging JSON parsing
      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logElement = document.getElementById("logs");
        logElement.innerHTML += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(`[Test Page] ${message}`);
      }

      function clearLogs() {
        document.getElementById("logs").innerHTML = "";
      }

      function logAction(action) {
        log(`User action: ${action}`);
      }

      function testWidget() {
        log("Testing widget injection...");

        // Check if widget script exists
        const existingScript = document.querySelector(
          'script[src*="/api/widget"]'
        );
        if (existingScript) {
          log("Widget script found - testing contextual question generation");

          // Trigger contextual question by scrolling or clicking
          window.scrollTo({ top: 100, behavior: "smooth" });
          setTimeout(() => {
            log("Scroll trigger sent - watch for contextual questions");
          }, 1000);
        } else {
          log("Widget script not found - injecting widget...");

          // Inject widget script for testing
          const script = document.createElement("script");
          script.src = "/api/widget?admin_id=test123";
          script.onload = () => {
            log("Widget script loaded successfully");
            setTimeout(() => {
              log("Testing contextual question generation...");
              window.scrollTo({ top: 200, behavior: "smooth" });
            }, 2000);
          };
          script.onerror = () => {
            log("ERROR: Widget script failed to load");
          };
          document.head.appendChild(script);
        }
      }

      function simulateContextualQuestion() {
        log("Simulating direct contextual question API call...");

        const testData = {
          sessionId: "test-session-" + Date.now(),
          pageUrl: window.location.href,
          contextualQuestionGeneration: true,
          contextualPageContext: {
            sectionName: "pricing",
            sectionData: {
              hasCtaButtons: true,
              hasPricing: true,
              hasTestimonials: true,
              hasFeatures: true,
            },
            contentAnalysis:
              "Premium Business Solutions page with enterprise pricing, features, and testimonials",
            pageUrl: window.location.href,
            timestamp: new Date().toISOString(),
          },
        };

        fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(testData),
        })
          .then((response) => response.json())
          .then((data) => {
            log("Contextual question response received:");
            log("Response structure: " + JSON.stringify(data, null, 2));

            // Check for proper JSON structure
            if (data.mainText && Array.isArray(data.buttons)) {
              log("âœ… SUCCESS: Proper JSON structure detected");
              log(`Main text: ${data.mainText}`);
              log(`Buttons: ${data.buttons.join(", ")}`);
              log(`Bot mode: ${data.botMode || "undefined"}`);
            } else {
              log("âŒ ERROR: Invalid response structure");
              if (typeof data.mainText === "object") {
                log(
                  "WARNING: mainText appears to be an object instead of string"
                );
              }
            }

            // Check for raw JSON in mainText (the bug we're fixing)
            if (data.mainText && data.mainText.includes('{"buttons"')) {
              log("âŒ CRITICAL ERROR: Raw JSON detected in mainText!");
            } else {
              log("âœ… SUCCESS: No raw JSON detected in mainText");
            }
          })
          .catch((error) => {
            log("âŒ ERROR: " + error.message);
          });
      }

      // Auto-test on page load
      window.addEventListener("load", () => {
        log("Page loaded - Enhanced contextual questions test ready");
        log(
          "This test verifies that AI responses are properly parsed and formatted"
        );

        // Auto-inject widget for testing
        setTimeout(() => {
          testWidget();
        }, 1000);
      });

      // Monitor for chat widget and log its behavior
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          if (mutation.type === "childList") {
            mutation.addedNodes.forEach(function (node) {
              if (node.nodeType === 1) {
                // Element node
                if (node.id && node.id.includes("chat")) {
                  log("Chat widget element detected: " + node.id);
                }
                if (node.className && node.className.includes("chat")) {
                  log("Chat widget with class detected: " + node.className);
                }
              }
            });
          }
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true,
      });
    </script>
  </body>
</html>
